# 内网IM接口协议设计

## 协议概述

基于WebSocket的内网即时通讯协议，使用JSON格式进行数据交换，每个消息包含endpoint路径和数据包。

## 基础消息格式

### 请求格式

```json
{
  "endpoint": "/endpoint_path",
  "data": {
    // 具体数据字段
  },
  "request_id": "uuid",
  // 可选，用于请求-响应匹配
  "timestamp": 1234567890
}
```

### 响应格式

```json
{
  "endpoint": "/endpoint_path_response",
  "data": {
    // 响应数据
  },
  "code": 200,
  // 状态码
  "message": "成功",
  // 状态描述
  "request_id": "uuid",
  // 对应请求的ID
  "timestamp": 1234567890
}
```

## 身份认证

### 登录认证

```json
// 请求
{
  "endpoint": "/auth/login",
  "data": {
    "username": "user1",
    "password": "encrypted_password",
    "client_type": "web/desktop/mobile",
    "device_id": "device_uuid"
  }
}

// 成功响应
{
  "endpoint": "/auth/login_response",
  "data": {
    "user_id": "uuid",
    "username": "user1",
    "token": "jwt_token",
    "expires_in": 86400,
    "user_info": {
      "nickname": "昵称",
      "avatar": "avatar_url",
      "department": "部门"
    }
  },
  "code": 200
}
```

### Token验证

```json
// 请求
{
  "endpoint": "/auth/verify",
  "data": {
    "token": "jwt_token"
  }
}
```

## 联系人管理

### 获取联系人列表

```json
// 请求
{
  "endpoint": "/contacts/list",
  "data": {
    "token": "xxxxx",
    "category": "all/friends/colleagues"
    // 可选
  }
}

// 响应
{
  "endpoint": "/contacts/list_response",
  "data": {
    "contacts": [
      {
        "user_id": "uuid",
        "username": "user2",
        "nickname": "昵称",
        "avatar": "avatar_url",
        "status": "online/offline/away/busy",
        "last_seen": 1234567890,
        "department": "部门",
        "tags": [
          "同事",
          "项目组A"
        ]
      }
    ]
  }
}
```

### 搜索用户

```json
// 请求
{
  "endpoint": "/contacts/search",
  "data": {
    "token": "xxxxx",
    "keyword": "搜索关键词",
    "department": "部门名",
    // 可选
    "limit": 20
  }
}
```

### 添加好友

```json
// 请求
{
  "token": "xxxxx",
  "endpoint": "/contacts/add",
  "data": {
    "target_user_id": "uuid",
    "message": "验证消息"
  }
}

// 通知（发送给被添加方）
{
  "endpoint": "/contacts/add_request",
  "data": {
    "from_user_id": "uuid",
    "from_username": "user1",
    "message": "验证消息",
    "request_id": "request_uuid"
  }
}

// 处理好友请求
{
  "endpoint": "/contacts/handle_request",
  "data": {
    "token": "xxxxx",
    "request_id": "request_uuid",
    "action": "accept/reject",
    "remark": "备注名"
    // 接受时可选
  }
}
```

## 单聊消息

### 发送消息

```json
// 请求
{
  "endpoint": "/message/send",
  "data": {
    "token": "xxxxx",
    "receiver_id": "uuid",
    "type": "text/image/file/link",
    "content": {
      "text": "消息内容",
      // 或文件信息
      "file_info": {
        "file_id": "uuid",
        "file_name": "文件名",
        "file_size": 1024,
        "file_type": "image/png",
        "url": "文件下载地址"
      }
    },
    "client_msg_id": "local_uuid",
    // 客户端消息ID，用于去重
    "reply_to": "message_id"
    // 可选，回复的消息ID
  }
}

// 发送成功响应
{
  "endpoint": "/message/send_response",
  "data": {
    "client_msg_id": "local_uuid",
    "server_msg_id": "server_uuid",
    "timestamp": 1234567890
  }
}

// 接收消息（实时推送）
{
  "endpoint": "/message/receive",
  "data": {
    "token": "xxxxx",
    "message_id": "server_uuid",
    "sender_id": "uuid",
    "sender_info": {
      "username": "user2",
      "nickname": "昵称"
    },
    "type": "text/image/file/link",
    "content": {
      // 消息内容
    },
    "timestamp": 1234567890,
    "reply_to": "message_id"
    // 可选
  }
}
```

### 消息状态同步

```json
// 消息已读回执
{
  "endpoint": "/message/read_receipt",
  "data": {
    "sender_id": "uuid",
    "message_ids": [
      "msg_id1",
      "msg_id2"
    ],
    "timestamp": 1234567890
  }
}

// 消息已送达回执
{
  "endpoint": "/message/delivery_receipt",
  "data": {
    "message_ids": [
      "msg_id1",
      "msg_id2"
    ]
  }
}

// 正在输入状态
{
  "endpoint": "/message/typing",
  "data": {
    "token": "xxxxx",
    "receiver_id": "uuid",
    "is_typing": true
  }
}
```

## 群聊功能

### 群组管理

```json
// 创建群组
{
  "endpoint": "/group/create",
  "data": {
    "token": "xxxxx",
    "name": "群组名称",
    "description": "群描述",
    "avatar": "群头像",
    "initial_members": [
      "user_id1",
      "user_id2"
    ]
  }
}

// 获取群组列表
{
  "endpoint": "/group/list",
  "token": "xxxxx"
  "data": {
  }
}

// 加入群组
{
  "endpoint": "/group/join",
  "data": {
    "token": "xxxxx",
    "group_id": "uuid",
    "password": "密码"
    // 如果群组需要密码
  }
}

// 邀请入群
{
  "endpoint": "/group/invite",
  "data": {
    "token": "xxxxx",
    "group_id": "uuid",
    "invitee_ids": [
      "user_id1",
      "user_id2"
    ]
  }
}

// 群组信息
{
  "endpoint": "/group/info",
  "data": {
    "group_id": "uuid"
  }
}
```

### 群聊消息

```json
// 发送群消息
{
  "endpoint": "/group/send_message",
  "data": {
    "token": "xxxxx",
    "group_id": "uuid",
    "type": "text/image/file",
    "content": {
      // 消息内容
    },
    "at_users": [
      "user_id1",
      "user_id2"
    ],
    // @的用户
    "at_all": false
    // 是否@所有人
  }
}

// 接收群消息
{
  "endpoint": "/group/receive_message",
  "data": {
    "token": "xxxxx",
    "group_id": "uuid",
    "message_id": "server_uuid",
    "sender_id": "uuid",
    "sender_info": {
      // 发送者信息
    },
    "type": "text/image/file",
    "content": {
      // 消息内容
    },
    "timestamp": 1234567890
  }
}
```

## 消息历史记录

### 获取历史消息

```json
// 请求
{
  "endpoint": "/history/get",
  "data": {
    "token": "xxxxx",
    "target_type": "user/group",
    "target_id": "uuid",
    "start_time": 1234567800,
    // 可选，开始时间戳
    "end_time": 1234567890,
    // 可选，结束时间戳
    "limit": 50,
    // 每次获取数量
    "last_msg_id": "msg_id"
    // 可选，最后一条消息ID
  }
}

// 响应
{
  "endpoint": "/history/get_response",
  "data": {
    "messages": [
      {
        // 消息对象
      }
    ],
    "has_more": true,
    "last_msg_id": "msg_id"
  }
}
```

## 在线状态

### 状态管理

```json
// 更新状态
{
  "endpoint": "/presence/update",
  "data": {
    "token": "xxxxx",
    "status": "online/away/busy/offline",
    "custom_status": "自定义状态",
    "expires_in": 300
    // 状态有效期
  }
}

// 状态变更通知（广播给联系人）
{
  "endpoint": "/presence/change",
  "data": {
    "user_id": "uuid",
    "username": "user1",
    "status": "online/away/busy/offline",
    "last_seen": 1234567890,
    "custom_status": "自定义状态"
  }
}

// 订阅状态
{
  "endpoint": "/presence/subscribe",
  "data": {
    "user_ids": [
      "user_id1",
      "user_id2"
    ]
  }
}
```

## 文件传输

### 文件上传

```json
// 获取上传凭证
{
  "endpoint": "/file/upload_token",
  "data": {
    "token": "xxxxx",
    "file_name": "文件名",
    "file_size": 1024,
    "file_type": "image/png"
  }
}

// 上传完成通知
{
  "endpoint": "/file/upload_complete",
  "data": {
    "file_id": "uuid",
    "file_name": "文件名",
    "file_size": 1024,
    "file_type": "image/png",
    "url": "文件访问地址",
    "thumbnail_url": "缩略图地址"
    // 图片类型
  }
}
```

## 系统通知

### 系统消息

```json
{
  "endpoint": "/system/notification",
  "data": {
    "type": "friend_request/group_invite/system_alert",
    "title": "通知标题",
    "content": "通知内容",
    "data": {
      // 附加数据
    },
    "timestamp": 1234567890,
    "expires_at": 1234567890
    // 过期时间
  }
}
```

## 错误处理

### 错误响应格式

```json
{
  "endpoint": "/error",
  "data": {
    "request_endpoint": "/original_endpoint",
    "code": 400,
    "message": "错误描述",
    "details": {
      // 错误详情
    }
  },
  "timestamp": 1234567890
}
```

### 常见错误码

- 200: 成功
- 400: 请求参数错误
- 401: 未授权/Token失效
- 403: 权限不足
- 404: 资源不存在
- 500: 服务器内部错误

## WebSocket连接管理

### 连接建立

1. 建立WebSocket连接：`ws://im-server:port/ws`
2. 发送认证消息（如已保存token）
3. 服务器返回连接成功响应

### 心跳机制

```json
// 客户端发送心跳
{
  "endpoint": "/heartbeat",
  "data": {
    "timestamp": 1234567890
  }
}

// 服务器响应
{
  "endpoint": "/heartbeat_response",
  "data": {
    "timestamp": 1234567890
  }
}
```

### 断线重连

1. 客户端检测到连接断开后自动重连
2. 重连成功后发送重连通知

```json
{
  "endpoint": "/reconnect",
  "data": {
    "token": "xxxxx",
    "last_msg_id": "最后收到的消息ID",
    "timestamp": 1234567890
  }
}
```

## 安全考虑

### 数据传输

1. 所有敏感数据（如密码）在客户端加密
2. 使用HTTPS/WSS协议传输
3. Token定期刷新机制

### 权限控制

1. 每个endpoint可配置权限要求
2. 消息发送频率限制
3. 文件上传大小限制

## 客户端实现建议

### 消息ID生成

```javascript
// 客户端消息ID生成规则
function generateClientMsgId() {
  return `${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
}
```

### 消息去重

1. 使用client_msg_id和server_msg_id进行消息去重
2. 维护已发送消息的本地缓存

### 离线消息处理

1. 重连后主动拉取离线期间的消息
2. 本地消息队列确保消息顺序
```json
{
  "endpoint": "/offline/get",
  "data": {
    "token": "xxxxx",
    "user_id": 0
  }
}
```
回应包：
```json
{
  "endpoint": "/offline/get_response",
  "data": {
    "messages": [
    ],
    "count": 0
  }
}
```
1. 创建群组
   请求:

```json
{
  "endpoint": "/group/create",
  "data": {
    "token": "xxxxx",
    "name": "群组名称",
    "description": "群描述"
  },
  "request_id": "optional_uuid",
  "token": "xxxxx"
}
```

响应:

```json
{
  "endpoint": "/group/create_response",
  "data": {
    "token": "xxxxx",
    "success": true,
    "group_id": "g_abc123",
    "group_name": "群组名称",
    "description": "群描述",
    "owner_id": 1,
    "created_at": 1234567890,
    "member_count": 1
  },
  "code": 200,
  "request_id": "optional_uuid"
}
```

2. 邀请加入群聊
   请求:

```json
{
  "endpoint": "/group/invite",
  "data": {  "token": "xxxxx",
    "group_id": "g_abc123",
    "invitee_ids": [
      2,
      3
    ]
  }
}
```

通知（发送给被邀请者）:

```json
{
  "endpoint": "/group/invitation_received",
  "data": {
    "invitation_id": "invite_uuid",
    "group_id": "g_abc123",
    "group_name": "群组名称",
    "inviter_id": 1,
    "inviter_name": "邀请者昵称",
    "created_at": 1234567890
  }
}
```

3. 发送群消息
   请求:

```json
{
  "endpoint": "/group/send_message",

  "data": {  "token": "xxxxx",
    "group_id": "g_abc123",
    "type": "text",
    "content": {
      "text": "消息内容"
    },
    "client_msg_id": "client_uuid",
    "at_users": [
      2,
      3
    ],
    "at_all": false
  }
}
```

接收群消息:

```json
{
  "endpoint": "/group/receive_message",

  "data": {  "token": "xxxxx",
    "message_id": "server_uuid",
    "group_id": "g_abc123",
    "sender_id": 1,
    "sender_info": {
      "user_id": 1,
      "username": "user1",
      "nickname": "用户昵称",
      "avatar": "avatar_url",
      "group_nickname": "群昵称",
      "role": "owner"
    },
    "type": "text",
    "content": {
      "text": "消息内容"
    },
    "timestamp": 1234567890,
    "at_users": [
      2,
      3
    ],
    "at_all": false
  }
}

```

4. 群通知

```json
{
  "endpoint": "/group/notification",
  "data": {
    "type": "member_joined/member_left/member_kicked/role_updated/group_disbanded",
    "group_id": "g_abc123",
    "user_id": 2,
    "user_name": "用户昵称",
    "operator_id": 1,
    "operator_name": "操作者昵称",
    "new_role": "admin",
    "timestamp": 1234567890,
    "message": "描述信息"
  }
}
```

客户端发送创建群组请求

```json
{
  "endpoint": "/group/create",
  "data": {  "token": "xxxxx",
    "name": "项目讨论群",
    "description": "项目进度同步和问题讨论",
    "avatar": "project.jpg",
    "initial_members": [
      2,
      3
    ]
  }
}
```

客户端发送群消息

```json
{
  "endpoint": "/group/message/send",
  "data": {
    "token": "xxxxx",
    "group_id": "g_abc123",
    "type": "text",
    "content": {
      "text": "大家好，今天会议取消"
    },
    "at_users": [
      2,
      3
    ],
    "at_all": false
  }
}
```